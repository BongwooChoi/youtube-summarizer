# -*- coding: utf-8 -*-
"""youtube-summarizer

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1bUyLCUoZN5edvEWONVaF3nUvG14z7yP7
"""

#!pip install ffmpeg-python streamlit yt-dlp openai-whisper openai langchain langchain_community

import ffmpeg
import streamlit as st
import yt_dlp
import whisper
import openai
from langchain.chat_models import ChatOpenAI
from langchain.schema import HumanMessage, SystemMessage
import os

# Streamlit ì•± ì œëª© ì„¤ì •
st.set_page_config(page_title="YouTube ì˜ìƒ ìš”ì•½ ì„œë¹„ìŠ¤", page_icon="ğŸ“º")

# ì œëª©ê³¼ ë¶€ì œëª©
st.title("YouTube ì˜ìƒ ìš”ì•½ë´‡")
st.subheader("ë°”ìœ í˜„ëŒ€ì¸, ë‹¹ì‹ ì˜ ì‹œê°„ì„ ì ˆì•½í•´ ë“œë¦½ë‹ˆë‹¤.")

# OpenAI API í‚¤ ê°€ì ¸ì˜¤ê¸°
openai_api_key = st.secrets["openai_api_key"]
os.environ["OPENAI_API_KEY"] = openai_api_key

# YouTube URL ì…ë ¥
youtube_url = st.text_input("YouTube ì˜ìƒ URLì„ ì…ë ¥í•˜ì„¸ìš”:")

if st.button("ì˜ìƒ ìš”ì•½í•˜ê¸°"):
    if not openai_api_key:
        st.error("OpenAI API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    elif not youtube_url:
        st.error("YouTube ì˜ìƒ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    else:
        try:
            # ì§„í–‰ ìƒíƒœ í‘œì‹œ
            progress_bar = st.progress(0)
            status_text = st.empty()

            # 1. YouTube ì˜ìƒ ë‹¤ìš´ë¡œë“œ
            status_text.text("YouTube ì˜ìƒ ë‹¤ìš´ë¡œë“œ ì¤‘...")
            ydl_opts = {
                'format': 'bestaudio/best',
                'postprocessors': [{
                    'key': 'FFmpegExtractAudio',
                    'preferredcodec': 'mp3',
                    'preferredquality': '192',
                }],
                'outtmpl': 'audio.%(ext)s'
            }
            with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                ydl.download([youtube_url])
            progress_bar.progress(25)

            # 2. ìŒì„± ì¸ì‹ (Whisper)
            status_text.text("ìŒì„±ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ ì¤‘...")
            model = whisper.load_model("small")
            result = model.transcribe("audio.mp3")
            transcription = result["text"]
            progress_bar.progress(50)

            # 3. í…ìŠ¤íŠ¸ ìš”ì•½ (GPT-4)
            status_text.text("í…ìŠ¤íŠ¸ ìš”ì•½ ì¤‘...")
            chat = ChatOpenAI(model_name="gpt-4o-mini", temperature=0)
            messages = [
                SystemMessage(content="ë‹¹ì‹ ì€ ë‚˜ ëŒ€ì‹  YouTubeë¥¼ ì‹œì²­í•˜ê³  ë‚´ìš©ì„ ì •ë¦¬í•´ì„œ ì•Œë ¤ì£¼ëŠ” Assistantì…ë‹ˆë‹¤."),
                HumanMessage(content=f"ì•„ë˜ ë‚´ìš©ì„ ê°€ë…ì„± ìˆëŠ” í•œ í˜ì´ì§€ ë³´ê³ ì„œ í˜•íƒœë¡œ ìš”ì•½í•˜ì„¸ìš”.:\n\n{transcription}")
            ]
            summary = chat(messages).content
            progress_bar.progress(75)

            # 4. ê²°ê³¼ í‘œì‹œ
            status_text.text("ìš”ì•½ ì™„ë£Œ!")
            st.subheader("ì˜ìƒ ìš”ì•½ ê²°ê³¼")
            st.write(summary)
            progress_bar.progress(100)

        except Exception as e:
            st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")

# ì£¼ì˜ì‚¬í•­ ë° ì•ˆë‚´
st.markdown("---")
st.markdown("**ì£¼ì˜ì‚¬í•­:**")
st.markdown("- ì´ ì„œë¹„ìŠ¤ëŠ” OpenAI APIë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ API ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ë¹„ìš©ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
st.markdown("- ì˜ìƒì˜ ê¸¸ì´ì™€ ë³µì¡ë„ì— ë”°ë¼ ì²˜ë¦¬ ì‹œê°„ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
st.markdown("- ì €ì‘ê¶Œ ë³´í˜¸ë¥¼ ìœ„í•´ ê°œì¸ì ì¸ ìš©ë„ë¡œë§Œ ì‚¬ìš©í•´ì£¼ì„¸ìš”.")
